from typing import List, Dict
import inspect
import gokart
import luigi
import pandas as pd

from .dataset import GetDataSet
from .utils import reduce_mem_usage


class FeatureFactory:
    def get_feature_instance(self, feature_name: str) -> gokart.TaskOnKart:

        """特徴量名を指定するとその特徴量クラスのインスタンスを返す
        Args:
            feature_name (str): 特徴量クラスの名前
        Returns:
            gokart.TaskOnKart
        """

        if feature_name in globals():
            return globals()[feature_name]()
        else:
            raise ValueError(f"{feature_name}って特徴量名は定義されてないよ!!!")

    def get_feature_task(self, features: List[str]) -> Dict[str, gokart.TaskOnKart]:
        tasks = {}
        for feature in features:
            tasks[feature] = self.get_feature_instance(feature)

        return tasks


class GetFeature(gokart.TaskOnKart):
    """ 特徴作成のための基底クラス """

    features = luigi.ListParameter()

    def feature_list(self) -> List[str]:
        """特徴量名リストを取得する"""
        lst: List[str] = []
        for name in globals():
            obj = globals()[name]
            if inspect.isclass(obj) and obj not in [
                GetDataSet,
                FeatureFactory,
                GetFeature,
                Feature,
                OriginFeature,
            ]:
                lst.append(obj.__name__)
        return lst

    def requires(self):
        ff = FeatureFactory()
        # もしparameterのfeaturesが空なら全部の特徴量を作る
        if not self.features:
            self.features = self.feature_list()
        return ff.get_feature_task(self.features)

    def run(self):
        data: pd.DataFrame = self.load("Target")

        for key in self.input().keys():
            print(key)
            if key == "Target":
                continue
            feature: pd.DataFrame = self.load(key)
            data = data.join(feature)
        self.dump(data)


# =================================================================================


class Feature(gokart.TaskOnKart):
    """ 基底クラス """

    index_columns = "MachineIdentifier"

    def requires(self):
        return GetDataSet()


class OriginFeature(Feature):
    """ データセットのデータをそのまま使える特徴量。 """

    target_feature = ""

    def run(self):
        required_columns = {self.index_columns, self.target_feature}
        dataset = self.load_data_frame(
            required_columns=required_columns, drop_columns=True
        )
        dataset = dataset.set_index(self.index_columns)
        dataset = reduce_mem_usage(dataset)
        self.dump(dataset)


# ===================================================================================


class Target(OriginFeature):
    target_feature = "HasDetections"


class RtpStateBitfield(OriginFeature):
    target_feature = "RtpStateBitfield"
